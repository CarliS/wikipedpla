var wp={title:$("#firstHeading").text(),categories:[],otherTitles:[],redirects:[]},apiKey="e4c036f3302aad8d8c188683967b9619",apiBase="http://api.dp.la/v2/items",catCounter=0,titleCounter=0,dpla={},suggestions=[],buildURI=function(e){return apiBase+"?api_key="+apiKey+"&q="+encodeURIComponent(e)+"&callback=handleResponse"},getCategories=function(){$("#mw-normal-catlinks li").each(function(e,t){wp.categories.push($(t).text())})},getOtherTitles=function(){$(".dablink").each(function(e,t){test=$(t).text().match('"(.*)" redirects here.'),test&&wp.otherTitles.push(test[1])})},getData=function(e){console.log("JSONP URI:",buildURI(e)),$("body").append('<script src="'+buildURI(e)+'"></script>')},handleResponse=function(e){dpla=e;var t=dpla.docs.length;t>0?(console.log(t," results."),buildSuggestions(displaySuggestions)):(console.log("No results in query."),titleCounter<wp.otherTitles.length?(getData(wp.otherTitles[titleCounter]),titleCounter++):catCounter<wp.categories.length&&(getData(wp.categories[catCounter]),catCounter++))},buildSuggestions=function(e){var t=dpla.docs,i={};t.forEach(function(e){var t=e.sourceResource;i.title=$.isArray(t.title)?t.title[0]:t.title,i.uri=e.isShownAt,i.type=$.isArray(t.type)?t.type[1]:t.type,i.isImage=isItAnImage(t),suggestions.push(i),i={}}),"function"==typeof e&&e()},displaySuggestions=function(){var e='<style>.dp-img:after { content: " "; background: url(https://upload.wikimedia.org/wikipedia/commons/a/a3/VisualEditor_-_Icon_-_Picture.svg); width: 12px; height: 12px; display: inline-block; background-size: 12px 12px;} }</style><div id="wikipedpla" class="dablink" style="display:none;">DPLA items of possible interest:',t=!1;suggestions.forEach(function(i,s,n){s==n.length-1&&(t=!0),t&&(e+=" & "),e+=' <a href="'+i.uri+'"',i.isImage&&(e+=' class="dp-img"'),e+=">"+i.title,e+=t?"</a>.":"</a>,"}),e+="</div>",$("#mw-content-text").prepend(e),$("#wikipedpla").show("slow")},isItAnImage=function(e){var t=e.type;if($.isArray(i)){for(var i in t)if("Image"==i)return!0;return!1}return t&&"image"===t.toLowerCase()?!0:!1},init=function(){var e=$('li[id^="ca-nstab-"]').attr("id");window.handleResponse||(window.handleResponse=handleResponse),"main"===e.substr(-4)&&(getCategories(),getOtherTitles(),getData(wp.title))};init();